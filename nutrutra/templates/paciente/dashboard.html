<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>NutriTra - Panel del paciente</title>

    <!-- fuente moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <!-- iconos -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    >

    <style>
      :root {
        --color-bg-1: #f5fbf7;
        --color-bg-2: #e3f3e8;
        --color-primary: #34c08a;
        --color-primary-soft: #e0f8ee;
        --color-text-main: #222831;
        --color-text-soft: #6b7280;
        --radius-xl: 22px;
      }

      body {
        min-height: 100vh;
        margin: 0;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--color-text-main);
        background: radial-gradient(circle at top left, var(--color-bg-2) 0, var(--color-bg-1) 40%, #ffffff 100%);
      }

      .navbar-nutri {
        border-bottom: 1px solid rgba(0,0,0,0.03);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.7);
      }

      .card-main {
        border-radius: var(--radius-xl);
        border: 1px solid rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.92);
        box-shadow:
          0 18px 45px rgba(15, 23, 42, 0.12),
          0 0 0 1px rgba(148, 163, 184, 0.08);
      }

      .badge-tag {
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        background: var(--color-primary-soft);
        color: var(--color-primary);
        font-size: 0.78rem;
        font-weight: 500;
      }

      .tag-nutri {
        font-size: 0.8rem;
        color: var(--color-text-soft);
      }

      .metric-card {
        border-radius: 18px;
        padding: 1rem 1rem 0.8rem;
        background: #f9fafb;
        border: 1px solid #edf2f7;
      }

      .progress {
        background-color: #edf2f7;
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-bar {
        border-radius: 999px;
        font-size: 0.75rem;
      }

      .kpi-number {
        font-size: 1.4rem;
        font-weight: 600;
      }

      .kpi-label {
        font-size: 0.8rem;
        color: var(--color-text-soft);
      }

      .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--color-text-soft);
      }

      .avatar-circle {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        background: linear-gradient(135deg, #34c08a, #7dd3fc);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .mini-chip {
        border-radius: 999px;
        padding: 0.13rem 0.55rem;
        background: #eef2ff;
        font-size: 0.7rem;
        color: #4f46e5;
      }

      .btn-primary-nutri {
        border-radius: 999px;
        background: var(--color-primary);
        border-color: var(--color-primary);
        font-weight: 500;
        font-size: 0.85rem;
        padding: 0.35rem 1.1rem;
      }

      .btn-primary-nutri:hover {
        background: #22a26f;
        border-color: #22a26f;
      }

      @media (max-width: 768px) {
        .card-main {
          border-radius: 18px;
          margin-top: 0.5rem;
        }
      }
    </style>
  </head>

  <body>
    <!-- nav -->
    <nav class="navbar navbar-light navbar-nutri sticky-top">
  <div class="container d-flex justify-content-between align-items-center">

    <span class="navbar-brand d-flex align-items-center gap-2 mb-0">
      <span class="rounded-circle d-inline-flex align-items-center justify-content-center"
            style="width: 30px; height: 30px; background: #dcfce7;">
        <i class="bi bi-heart-pulse-fill" style="font-size: 1rem; color: #22c55e;"></i>
      </span>
      <span class="fw-semibold">NutriTra</span>
    </span>

    <div class="d-flex align-items-center gap-3">
      <span class="tag-nutri d-none d-sm-inline">
        <i class="bi bi-calendar-heart me-1"></i>
        Hoy: {{ hoy }}
      </span>

      <!-- Botón Cerrar sesión -->
      <form method="post" action="{% url 'logout' %}" class="m-0 p-0">
  {% csrf_token %}
  <button type="submit" class="btn btn-link btn-sm text-muted">
    <i class="bi bi-box-arrow-right me-1"></i>
    Cerrar sesión
  </button>
      </form>
      </div>
      </div>
    </nav>



    <main class="container py-4 py-md-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-9">
          <div class="card-main p-3 p-md-4">
            <!-- header -->
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 mb-md-4">
              <div class="d-flex align-items-center gap-3 mb-3 mb-md-0">
                <div class="avatar-circle">
                  {{ paciente.user.first_name|default:paciente.user.username|slice:":1"|upper }}
                </div>
                <div>
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h2 class="h5 mb-0">
                      Hola, {{ paciente.user.first_name|default:paciente.user.username }}
                    </h2>
                    {% if paciente.tipo_dieta %}
                      <span class="mini-chip">
                        <i class="bi bi-leaf"></i>
                        {{ paciente.get_tipo_dieta_display }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="tag-nutri mt-1">
                    Tu resumen nutricional de hoy
                  </div>
                </div>
              </div>

              <div class="d-flex flex-column align-items-md-end gap-2">
                <span class="badge-tag">
                  <i class="bi bi-activity me-1"></i>
                  Objetivo: {{ paciente.get_objetivo_peso_tipo_display|default:"-" }}
                </span>

                <a href="{% url 'registrar_comida' %}" class="btn btn-primary-nutri">
                  <i class="bi bi-plus-circle me-1"></i>
                  Registrar comida
                </a>
              </div>
            </div>

            <!-- KPIs principales -->
            <div class="row g-3 mb-3 mb-md-4">
              <div class="col-12 col-md-4">
                <div class="metric-card h-100 d-flex flex-column justify-content-between">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                      <div class="kpi-label">Calorías consumidas</div>
                      <div class="kpi-number">
                        {{ calorias_hoy|floatformat:0 }}<span class="fs-6 text-muted"> kcal</span>
                      </div>
                    </div>
                    <span class="rounded-circle d-inline-flex align-items-center justify-content-center"
                          style="width: 34px; height: 34px; background:#dcfce7;">
                      <i class="bi bi-fire" style="color:#22c55e;"></i>
                    </span>
                  </div>
                  <div class="small text-muted">
                    Objetivo: {{ paciente.calorias_objetivo_diarias|default:"-" }} kcal
                  </div>
                </div>
              </div>

              <div class="col-6 col-md-4">
                <div class="metric-card h-100">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                      <div class="kpi-label">Hierro del día</div>
                      <div class="kpi-number">
                        {{ hierro_hoy|floatformat:1 }}<span class="fs-6 text-muted"> mg</span>
                      </div>
                    </div>
                    <span class="rounded-circle d-inline-flex align-items-center justify-content-center"
                          style="width: 34px; height: 34px; background:#fee2e2;">
                      <i class="bi bi-droplet-half" style="color:#ef4444;"></i>
                    </span>
                  </div>
                  <div class="small text-muted">
                    Objetivo diario de hierro según tu plan.
                  </div>
                </div>
              </div>

              <div class="col-6 col-md-4">
                <div class="metric-card h-100">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                      <div class="kpi-label">Vitamina B12</div>
                      <div class="kpi-number">
                        {{ b12_hoy|floatformat:2 }}<span class="fs-6 text-muted"> µg</span>
                      </div>
                    </div>
                    <span class="rounded-circle d-inline-flex align-items-center justify-content-center"
                          style="width: 34px; height: 34px; background:#e0f2fe;">
                      <i class="bi bi-capsule" style="color:#2563eb;"></i>
                    </span>
                  </div>
                  <div class="small text-muted">
                    Seguimiento de B12 a lo largo del día.
                  </div>
                </div>
              </div>
            </div>

            <!-- MACRONUTRIENTES -->
            <div class="mb-3 mb-md-4">
              <div class="section-title mb-2">Macronutrientes de hoy</div>
              <div class="row g-3">
                <div class="col-4">
                  <div class="metric-card text-center">
                    <div class="kpi-label mb-1">Proteínas</div>
                    <div class="kpi-number">
                      {{ proteinas_hoy|floatformat:0 }}<span class="fs-6 text-muted"> g</span>
                    </div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-card text-center">
                    <div class="kpi-label mb-1">Carbohidratos</div>
                    <div class="kpi-number">
                      {{ carbohidratos_hoy|floatformat:0 }}<span class="fs-6 text-muted"> g</span>
                    </div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="metric-card text-center">
                    <div class="kpi-label mb-1">Grasas</div>
                    <div class="kpi-number">
                      {{ grasas_hoy|floatformat:0 }}<span class="fs-6 text-muted"> g</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- barras progreso -->
            <div class="mb-3 mb-md-4">
              <div class="section-title mb-2">Progreso de hoy</div>

              <!-- Calorías totales -->
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="fw-semibold">
                    <i class="bi bi-fire me-1 text-warning"></i>
                    Calorías totales
                  </span>
                  <span class="small text-muted">
                    {{ calorias_pct }}%
                  </span>
                </div>
                <div class="progress" style="height: 16px;">
                  <div
                    class="progress-bar
                           {% if calorias_pct < 90 %}bg-info
                           {% elif calorias_pct <= 110 %}bg-success
                           {% else %}bg-warning{% endif %}"
                    role="progressbar"
                    style="width: {{ calorias_pct }}%;"
                  ></div>
                </div>
              </div>

              <!-- Calorías desde alcohol -->
<div class="mb-1">
  <div class="d-flex justify-content-between align-items-center mb-1">
    <span class="fw-semibold">
      <i class="bi bi-cup-straw me-1 text-danger"></i>
      Calorías desde alcohol
    </span>
    <span class="small text-muted">
      {{ calorias_alcohol_hoy|floatformat:0 }} kcal ({{ alcohol_pct }}%)
    </span>
  </div>
  <div class="progress" style="height: 16px;">
    <div
      class="progress-bar
             {% if alcohol_pct <= 50 %}bg-success
             {% elif alcohol_pct <= 100 %}bg-warning
             {% else %}bg-danger{% endif %}"
      role="progressbar"
      style="width: {{ alcohol_pct }}%;"
    ></div>
  </div>
  <div class="small text-muted mt-1">
    Aproximamos un máximo saludable de ~15% de tus calorías desde alcohol.
  </div>
</div>

            <!-- sección glucemia -->
            <div class="mt-3 pt-3 border-top">
              <div class="section-title mb-2">Glucemia</div>

              {% if ultima_glucemia %}
                <p class="small text-muted mb-1">
                  Última medición: {{ ultima_glucemia.valor_mg_dl }} mg/dL
                  ({{ ultima_glucemia.fecha_hora }})
                </p>
              {% else %}
                <p class="small text-muted mb-1">
                  Todavía no registraste mediciones de glucemia.
                </p>
              {% endif %}

              <a href="{% url 'lista_alimentos' %}" class="btn btn-sm btn-outline-secondary mt-2">
                <i class="bi bi-table me-1"></i>
                Ver tabla de alimentos e IG
              </a>
            </div>
            <!--Seccion notas-->
          {% if notas_visibles %}
              <div class="mt-4 pt-3 border-top">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="section-title mb-0">Notas de tu nutricionista</span>
                  <small class="text-muted">
                    Últimas {{ notas_visibles|length }} notas
                  </small>
                </div>

                <div class="row g-2">
                  {% for nota in notas_visibles %}
                    <div class="col-12">
                      <div class="metric-card">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <strong>{{ nota.titulo|default:"Nota de seguimiento" }}</strong>
                          <span class="tag-nutri">{{ nota.fecha }}</span>
                        </div>
                        <p class="small mb-0" style="white-space: pre-line;">
                          {{ nota.texto }}
                        </p>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

